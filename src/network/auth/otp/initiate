// POST /auth/otp/initiate
app.post('/auth/otp/initiate', async (req, res) => {
  const { phone, code, purpose = 'register' } = req.body;
  if (!phone || !code) return res.status(400).json({ success: false, message: 'Missing phone/code' });

  // TODO: upsert OTP { phone, codeHash, purpose, expiresAt, attempts } in your DB
  // const codeHash = await bcrypt.hash(code, 10)

  const resp = await fetch(`${process.env.INFOBIP_BASE}/sms/2/text/advanced`, {
    method: 'POST',
    headers: {
      'Authorization': `App ${process.env.INFOBIP_API_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      messages: [{
        destinations: [{ to: phone }],
        from: 'KIS', // or approved sender; trial may use a default
        text: `Your KIS verification code is ${code}. It expires in 10 minutes.`
      }]
    })
  });

  if (!resp.ok) {
    const txt = await resp.text();
    return res.status(502).json({ success: false, message: 'SMS provider error', detail: txt });
  }
  return res.json({ success: true });
});
